<% if (typeof user !== 'undefined' && user) { %>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-dark">Панель керування</h1>
            <p class="text-muted mb-0">Вітаємо, <strong><%= user.pib %></strong>! Ось статус комп'ютерного залу.</p>
        </div>

        <div class="d-flex gap-2">
            <% if (['DB_ADMIN', 'PROGRAMMER', 'OPERATOR'].includes(user.role)) { %>
                <a href="/logs" class="btn btn-white border shadow-sm fw-bold text-secondary" title="Перегляд подій системи">
                    <i class="bi bi-journal-text me-2"></i>Логи
                </a>
            <% } %>

            <% if (user.role === 'DB_ADMIN') { %>
                <a href="/computer/create-form" class="btn btn-primary shadow-sm fw-bold">
                    <i class="bi bi-plus-lg me-2"></i>Додати ПК
                </a>
            <% } %>
        </div>
    </div>
    
    <% if (typeof flashMessage !== 'undefined' && flashMessage) { %>
        <div class="alert alert-<%= flashMessage.type %> alert-dismissible fade show shadow-sm border-0 border-start border-5 rounded-3 mb-4" role="alert" style="border-left-color: var(--bs-<%= flashMessage.type %>) !important;">
            
            <div class="d-flex align-items-center">
                <% if (flashMessage.type === 'success') { %>
                    <i class="bi bi-check-circle-fill fs-4 me-3 text-success"></i>
                <% } else { %>
                    <i class="bi bi-exclamation-triangle-fill fs-4 me-3 text-danger"></i>
                <% } %>
                
                <div>
                    <h6 class="alert-heading fw-bold mb-1">
                        <%= flashMessage.type === 'success' ? 'Чудово!' : 'Помилка!' %>
                    </h6>
                    <p class="mb-0 small"><%= flashMessage.message %></p>
                </div>
            </div>
    
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>

    <div class="card border-0 shadow-sm mb-4 rounded-4 overflow-hidden">
        <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
            <h6 class="text-uppercase text-muted fw-bold small ls-1">
                <i class="bi bi-sliders2 me-2"></i>Фільтрація та пошук
            </h6>
        </div>

        <div class="card-body p-4">
            <form action="/computer" method="GET" class="row g-3">
                <div class="col-md-5">
                    <label class="form-label fw-bold text-dark small">Пошук ПК</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0 text-muted">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" name="search" class="form-control bg-light border-start-0"
                               placeholder="Назва або локація..."
                               value="<%= query.search || '' %>">
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label fw-bold text-dark small">Статус</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0 text-muted">
                            <i class="bi bi-activity"></i>
                        </span>
                        <select name="status" class="form-select bg-light border-start-0 cursor-pointer">
                            <option value="">Всі варіанти</option>
                            <option value="AVAILABLE" <%= query.status === 'AVAILABLE' ? 'selected' : '' %>>Вільний</option>
                            <option value="BUSY" <%= query.status === 'BUSY' ? 'selected' : '' %>>Зайнятий</option>
                            <option value="MAINTENANCE" <%= query.status === 'MAINTENANCE' ? 'selected' : '' %>>Ремонт</option>
                        </select>
                    </div>
                </div>

                <div class="col-md-3 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-primary flex-grow-1 fw-bold">
                        Знайти
                    </button>
                    <a href="/computer" class="btn btn-light border text-muted d-flex align-items-center justify-content-center"
                       style="width: 40px;" title="Скинути">
                        <i class="bi bi-x-lg"></i>
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5">
        <% computers.forEach(function(pc) { %>
            <div class="col">
                <%
                    // Візуальна логіка
                    let borderClass = 'border-success';
                    let statusBadge = 'bg-success';
                    let statusText = 'Вільний';
                    let icon = 'bi-display';

                    if (pc.status === 'BUSY') {
                        borderClass = 'border-danger';
                        statusBadge = 'bg-danger';
                        statusText = 'Зайнятий';
                        icon = 'bi-controller';
                    } else if (pc.status === 'MAINTENANCE') {
                        borderClass = 'border-warning';
                        statusBadge = 'bg-warning text-dark';
                        statusText = 'Ремонт';
                        icon = 'bi-tools';
                    }
                %>

                <div class="card h-100 shadow-sm <%= borderClass %>" style="border-width: 2px;">
                    <div class="card-body d-flex flex-column p-4">
    
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h5 class="card-title d-flex align-items-center mb-1 fw-bold text-dark">
                                    <i class="bi <%= icon %> me-2 text-primary opacity-75"></i>
                                    <%= pc.inventoryNumber %>

                                    <button type="button" class="btn btn-link text-muted p-0 ms-2"
                                            data-bs-toggle="modal"
                                            data-bs-target="#specsModal"
                                            data-inv="<%= pc.inventoryNumber %>"
                                    <% if (pc.specs) { %>
                                            data-cpu="<%= pc.specs.cpu || '-' %>"
                                            data-ram="<%= pc.specs.ram || '-' %>"
                                            data-storage="<%= pc.specs.storage || '-' %>"
                                            data-gpu="<%= pc.specs.gpu || '-' %>"
                                    <% } else { %>
                                            data-cpu="Не вказано" data-ram="-" data-storage="-" data-gpu="-"
                                            <% } %>
                                            title="Переглянути характеристики">
                                        <i class="bi bi-info-circle-fill fs-5 opacity-50 hover-opacity-100"></i>
                                    </button>
                                </h5>
                                <small class="text-muted"><i class="bi bi-geo-alt-fill me-1 opacity-50"></i><%= pc.location %></small>
                            </div>
                            
                            <% if (pc.status === 'BUSY') { %>
                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 rounded-pill d-inline-flex align-items-center px-3 py-2">
                                    <span class="spinner-grow spinner-grow-sm me-2" role="status" style="width: 0.4rem; height: 0.4rem;"></span>
                                    Зайнятий
                                </span>
                            <% } else if (pc.status === 'MAINTENANCE') { %>
                                <span class="badge bg-warning bg-opacity-10 text-warning border border-warning border-opacity-25 rounded-pill px-3 py-2 text-dark">
                                    <i class="bi bi-tools me-1"></i> Ремонт
                                </span>
                            <% } else { %>
                                <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill px-3 py-2">
                                    <i class="bi bi-check-circle me-1"></i> Вільний
                                </span>
                            <% } %>
                        </div>
                    
                        <div class="mb-4 mt-2">
                            <% if (pc.status === 'BUSY') { %>
                                <div class="p-2 rounded-3 bg-light border border-light">
                                    <small class="text-muted d-block mb-1">Поточний стан:</small>
                                    <div class="d-flex align-items-center text-dark small fw-bold">
                                        <i class="bi bi-person-fill me-2 text-primary"></i> Йде активна сесія...
                                    </div>
                                </div>
                            <% } else if (pc.status === 'MAINTENANCE') { %>
                                <div class="p-2 rounded-3 bg-warning bg-opacity-10 border border-warning border-opacity-10">
                                    <small class="text-dark d-block mb-1 opacity-75">Поточний стан:</small>
                                    <div class="d-flex align-items-center text-dark small fw-bold">
                                        <i class="bi bi-cone-striped me-2"></i> Технічне обслуговування
                                    </div>
                                </div>
                            <% } else { %>
                                <div class="p-2 rounded-3 bg-light border border-light">
                                    <small class="text-muted d-block mb-1">Поточний стан:</small>
                                    <div class="d-flex align-items-center text-success small fw-bold">
                                        <i class="bi bi-power me-2"></i> Готовий до роботи
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    
                        <div class="mt-auto d-grid gap-2">
                            <% if (pc.status === 'AVAILABLE') { %>
                                <% if (user.role === 'HARDWARE_SPECIALIST') { %>
                                    <form action="/computer/maintenance/start" method="POST" class="d-grid">
                                        <input type="hidden" name="computerId" value="<%= pc.id %>">
                                        <button type="submit" class="btn btn-warning fw-bold shadow-sm text-dark border-0">
                                            <i class="bi bi-tools me-1"></i> Почати ремонт
                                        </button>
                                    </form>
                                <% } else { %>
                                    <form action="/session/start" method="POST" class="d-grid">
                                        <input type="hidden" name="computerId" value="<%= pc.id %>">
                                        <button type="submit" class="btn btn-primary fw-bold shadow-sm border-0">
                                            <i class="bi bi-play-fill me-1"></i> Почати сеанс
                                        </button>
                                    </form>
                                <% } %>
                    
                            <% } else if (pc.status === 'BUSY') { %>
                                <% if (user.role === 'DB_ADMIN') { %>
                                    <form action="/session/session-end" method="POST" class="d-grid">
                                        <input type="hidden" name="computerId" value="<%= pc.id %>">
                                        <button type="submit" class="btn btn-outline-danger fw-bold shadow-sm">
                                            <i class="bi bi-stop-circle me-1"></i> Примусово завершити
                                        </button>
                                    </form>
                                <% } else if (typeof activeComputerId !== 'undefined' && activeComputerId === pc.id) { %>
                                    <form action="/session/end" method="POST" class="d-grid">
                                        <input type="hidden" name="computerId" value="<%= pc.id %>">
                                        <button type="submit" class="btn btn-danger fw-bold shadow-sm border-0">
                                            <i class="bi bi-box-arrow-right me-1"></i> Завершити роботу
                                        </button>
                                    </form>
                                <% } else { %>
                                    <button class="btn btn-light text-muted border shadow-sm" disabled>
                                        <i class="bi bi-lock-fill me-1"></i> Доступ заборонено
                                    </button>
                                <% } %>
                    
                            <% } else if (pc.status === 'MAINTENANCE') { %>
                                <% if (user.role === 'HARDWARE_SPECIALIST' || user.role === 'DB_ADMIN') { %>
                                    <form action="/computer/maintenance/end" method="POST" class="d-grid">
                                        <input type="hidden" name="computerId" value="<%= pc.id %>">
                                        <button class="btn btn-success text-white fw-bold shadow-sm border-0">
                                            <i class="bi bi-check-lg me-1"></i> Завершити ремонт
                                        </button>
                                    </form>
                                <% } else { %>
                                    <button class="btn btn-light text-muted border shadow-sm" disabled>
                                        <i class="bi bi-cone-striped me-1"></i> Ведуться роботи
                                    </button>
                                <% } %>
                            <% } %>
                        </div>
                    
                        <% if (user.role === 'DB_ADMIN') { %>
                            <hr class="my-3 opacity-10">
                            <form action="/computer/delete" method="POST" onsubmit="return confirm('Ви впевнені? Це дію не можна відмінити.');" class="text-center">
                                <input type="hidden" name="id" value="<%= pc.id %>">
                                <button type="submit" class="btn btn-link btn-sm text-muted text-decoration-none p-0 opacity-75 hover-opacity-100">
                                    <i class="bi bi-trash3 me-1"></i> Видалити з бази
                                </button>
                            </form>
                        <% } %>
                    </div>
                </div>
            </div>
        <% }); %>
    </div>

    <% if (computers.length === 0) { %>
        <div class="text-center py-5 text-muted bg-light rounded-4">
            <i class="bi bi-pc-display fs-1"></i>
            <p class="mt-2 mb-0">Комп'ютери не знайдені.</p>
        </div>
    <% } %>

<% } else { %>
    <div class="px-4 py-5 my-5 text-center">
        <div class="mb-4">
            <span class="d-inline-flex align-items-center justify-content-center bg-primary bg-opacity-10 text-primary rounded-circle" style="width: 100px; height: 100px;">
                <i class="bi bi-pc-display" style="font-size: 3rem;"></i>
            </span>
        </div>

        <h1 class="display-5 fw-bold text-dark mb-3">Computer Center</h1>
        <div class="col-lg-6 mx-auto">
            <p class="lead mb-5 text-muted">
                Автоматизована система обліку робочого часу та управління ресурсами обчислювального центру.
                Контролюйте доступ, час сеансів та стан обладнання в реальному часі.
            </p>

            <div class="d-flex gap-3 justify-content-center">
                <a href="/auth/login" class="btn btn-primary btn-lg px-5 py-3 shadow-sm rounded-pill fw-bold">
                    <i class="bi bi-box-arrow-in-right me-2"></i> Увійти в систему
                </a>
            </div>
            
            <p class="mt-4 small text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Доступ до системи надається виключно співробітникам центру.
            </p>
        </div>
    </div>
<% } %>
<div class="modal fade" id="specsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm"> <div class="modal-content rounded-4 border-0 shadow">

            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Характеристики</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body pt-2">
                <p class="text-muted small mb-4">
                    ПК: <strong id="modalInv" class="text-dark font-monospace"></strong>
                </p>

                <div class="d-flex align-items-center mb-3">
                    <div class="bg-primary bg-opacity-10 rounded p-2 me-3 text-primary">
                        <i class="bi bi-cpu fs-5"></i>
                    </div>
                    <div>
                        <div class="small text-muted fw-bold text-uppercase" style="font-size: 0.65rem;">Процесор</div>
                        <div class="fw-bold text-dark small" id="modalCpu">-</div>
                    </div>
                </div>

                <div class="d-flex align-items-center mb-3">
                    <div class="bg-success bg-opacity-10 rounded p-2 me-3 text-success">
                        <i class="bi bi-memory fs-5"></i>
                    </div>
                    <div>
                        <div class="small text-muted fw-bold text-uppercase" style="font-size: 0.65rem;">ОЗП (RAM)</div>
                        <div class="fw-bold text-dark small" id="modalRam">-</div>
                    </div>
                </div>

                <div class="d-flex align-items-center mb-3">
                    <div class="bg-warning bg-opacity-10 rounded p-2 me-3 text-dark">
                        <i class="bi bi-hdd fs-5"></i>
                    </div>
                    <div>
                        <div class="small text-muted fw-bold text-uppercase" style="font-size: 0.65rem;">Накопичувач</div>
                        <div class="fw-bold text-dark small" id="modalStorage">-</div>
                    </div>
                </div>

                <div class="d-flex align-items-center">
                    <div class="bg-info bg-opacity-10 rounded p-2 me-3 text-info">
                        <i class="bi bi-gpu-card fs-5"></i>
                    </div>
                    <div>
                        <div class="small text-muted fw-bold text-uppercase" style="font-size: 0.65rem;">Відеокарта</div>
                        <div class="fw-bold text-dark small" id="modalGpu">-</div>
                    </div>
                </div>

            </div>

            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light btn-sm w-100 rounded-pill" data-bs-dismiss="modal">Закрити</button>
            </div>
        </div>
    </div>
</div>

<script>
    const specsModal = document.getElementById('specsModal');
    if (specsModal) {
        specsModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget;

            const inv = button.getAttribute('data-inv');
            const cpu = button.getAttribute('data-cpu');
            const ram = button.getAttribute('data-ram');
            const storage = button.getAttribute('data-storage');
            const gpu = button.getAttribute('data-gpu');

            specsModal.querySelector('#modalInv').textContent = inv;
            specsModal.querySelector('#modalCpu').textContent = cpu;
            specsModal.querySelector('#modalRam').textContent = ram;
            specsModal.querySelector('#modalStorage').textContent = storage;
            specsModal.querySelector('#modalGpu').textContent = gpu;
        });
    }
</script>